version: '3.8'

services:
  # Development environment
  qmann-dev:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: development
    container_name: qmann-dev
    ports:
      - "8888:8888"  # Jupyter Lab
      - "5000:5000"  # MLflow
      - "6006:6006"  # TensorBoard
    volumes:
      - .:/app
      - qmann-data:/app/data
      - qmann-results:/app/results
      - qmann-models:/app/models
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - PYTHONPATH=/app/src
      - MLFLOW_TRACKING_URI=http://localhost:5000
    labels:
      - "org.opencontainers.image.title=QMANN Development"
      - "org.opencontainers.image.description=Quantum Memory-Augmented Neural Networks Development Environment"
      - "org.opencontainers.image.vendor=Neura Parse"
      - "org.opencontainers.image.version=1.0.0"
      - "org.opencontainers.image.url=https://neuraparse.com"
      - "org.opencontainers.image.source=https://github.com/neuraparse/QMANN"
    networks:
      - qmann-network
    stdin_open: true
    tty: true
    command: >
      bash -c "
        mlflow server --host 0.0.0.0 --port 5000 --backend-store-uri sqlite:///mlflow.db &
        tensorboard --logdir=./logs --host=0.0.0.0 --port=6006 &
        jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root
      "

  # Production environment
  qmann-prod:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: production
    container_name: qmann-prod
    volumes:
      - qmann-data:/app/data
      - qmann-results:/app/results
      - qmann-models:/app/models
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - PYTHONPATH=/app/src
    networks:
      - qmann-network
    profiles:
      - production

  # Benchmark runner
  qmann-benchmark:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: benchmark
    container_name: qmann-benchmark
    volumes:
      - qmann-data:/app/data
      - qmann-results:/app/results
      - ./benchmarks:/app/benchmarks
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - PYTHONPATH=/app/src
    networks:
      - qmann-network
    profiles:
      - benchmark

  # Paper compilation
  qmann-paper:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: paper
    container_name: qmann-paper
    volumes:
      - ./paper:/paper
      - qmann-paper-output:/paper/out
    networks:
      - qmann-network
    profiles:
      - paper

  # MLflow tracking server
  mlflow:
    image: python:3.11-slim
    container_name: qmann-mlflow
    ports:
      - "5000:5000"
    volumes:
      - qmann-mlflow:/mlflow
    environment:
      - MLFLOW_BACKEND_STORE_URI=sqlite:///mlflow/mlflow.db
      - MLFLOW_DEFAULT_ARTIFACT_ROOT=/mlflow/artifacts
    networks:
      - qmann-network
    command: >
      bash -c "
        pip install mlflow[extras] &&
        mlflow server 
          --backend-store-uri sqlite:///mlflow/mlflow.db 
          --default-artifact-root /mlflow/artifacts 
          --host 0.0.0.0 
          --port 5000
      "
    profiles:
      - mlflow

  # Redis for caching (optional)
  redis:
    image: redis:7-alpine
    container_name: qmann-redis
    ports:
      - "6379:6379"
    volumes:
      - qmann-redis:/data
    networks:
      - qmann-network
    profiles:
      - cache

  # PostgreSQL for metadata (optional)
  postgres:
    image: postgres:15-alpine
    container_name: qmann-postgres
    ports:
      - "5432:5432"
    volumes:
      - qmann-postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=qmann
      - POSTGRES_USER=qmann
      - POSTGRES_PASSWORD=qmann_password
    networks:
      - qmann-network
    profiles:
      - database

  # Quantum simulator service (if using remote simulators)
  qsim:
    image: qiskit/qasm-simulator
    container_name: qmann-qsim
    ports:
      - "8080:8080"
    networks:
      - qmann-network
    profiles:
      - quantum

networks:
  qmann-network:
    driver: bridge

volumes:
  qmann-data:
    driver: local
  qmann-results:
    driver: local
  qmann-models:
    driver: local
  qmann-paper-output:
    driver: local
  qmann-mlflow:
    driver: local
  qmann-redis:
    driver: local
  qmann-postgres:
    driver: local
